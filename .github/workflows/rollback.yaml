# Parameters: Environment, google project name
name: deploy
on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to publish, 'production', 'develop'
        default: develop
        required: true
      gitversiontag:
        description: The Git tag to deploy, either a specific tag in the form of 'v#.#.#' or a number to roll back by (default is '1' or back one)
        default: 1
        required: true
jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      # Checkout the codebase
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          submodules: false
      # Set the node version
      - name: Build on nodejs 16.x
        uses: actions/setup-node@v1
        with:
          node-version: '16'
      # Install a minimal amount of dependencies: gulp and error-plugin for gulp
      - run: cp -rf gulpfile.js/package.json package.json
      - run: yarn install --unsafe-perm
      # Login into Docker Hub
      - run: docker login -u ${{ secrets.DOCKER_HUB_USER }} -p ${{ secrets.DOCKER_HUB_TOKEN }}
      # Rollback to the given tag.
      - name: Rollback to a tag
        run: |
          gulp rollback --"${{ github.event.inputs.environment }}" --"${{ github.event.inputs.gitversiontag }}"
        env:
          GCLOUD_KEY: ${{ secrets.GCLOUD_DEVELOP_KEY }}

