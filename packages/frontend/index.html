<!DOCTYPE html>
<html lang="en">
    <!--This file is not used within the docker container, see index.html.template.-->

    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>

        <style>
            .c60-panel {
                background-color: lightgrey;
            }
        </style>
    </head>
    <body>
        <div class="ui centered aligned container" style="margin: 50px;">
            <div class="ui segment">
                <h1 class='border-1'>Sample Kubernetes Project</h1>
                <p>
                    This project has a frontend that talks to a core back end service
                    that is exposed to the world at the /api endpoint. The API is called every second.
                    The results are presented below.
                </p>

                <div class="ui divider"></div>

                <div class="ui statistic">
                    <div id="counter" class="value"></div>
                    <div class="label">requests</div>
                </div>

                <div id="data-dump"></div>

            </div>
        </div>

        <div></div>
        <h1>Core API</h1>
        <p id="api-info">...</p>
        <p id="api-response">...</p>
        <h3>Socket</h3>
        <p id="ws-info">...</p>
        <p id="ws-support">...</p>
        <p id="ws-messages">...</p>
        <p id="ws-ping-messages">...</p>
        <p id="ws-sent">...</p>
        <p id="ws-closed">...</p>
        <script>
            const isLocal = window.location.hostname === 'localhost'
            // URL's depend if we are running in cluster or not
            // We can use the hostname to determine configuration
            // When localhost, we are doing local development
            const coreAPIURL = isLocal ?
                'http://localhost:3000/api' :
                '/api'

            let counter = 0
            function WebSocketTest() {
                if ("WebSocket" in window) {
                    //const url = "ws://localhost:8002" // for docker build local run
                    const loc = window.location
                    const protocol = (loc.protocol === "https:") ? "wss:" : "ws:"
                    const socket_uri = `${protocol}//${loc.host}${loc.pathname}sockets/`

                    $('#ws-info').html("Communicating with WebSockets at: " + socket_uri)
                    $('#ws-support').html("WebSocket is supported by this Browser!")
                    const ws = new WebSocket(socket_uri)
                    ws.onopen = function() {
                        // Web Socket is connected, send data using send()
                        $('#ws-sent').html("Sent Message:\"Hello World\"")
                        ws.send(`Hello World ${counter}`)
                    };
                    ws.onmessage = function (evt) {
                        const received_msg = evt.data
                        if (received_msg.includes('PING'))
                            $('#ws-ping-messages').html("Ping received: "+received_msg)

                        else
                            $('#ws-messages').html("Message received: "+received_msg)

                    };
                    ws.onclose = function() {
                        $('#ws-closed').html(`Closed connection ${counter}...`)
                    };
                } else {
                    $('#ws-support').html("Error: WebSocket NOT supported by this Browser!")
                }
            }

            function renderSection(section, success, payload) {
                return `<div class="ui divider"></div>
                <div class="ui two column grid">
                    <div class="row">
                      <div class="column">
                        <h2>${section}</h2>
                        <table class="ui celled table">
                            <thead>
                              <tr><th>Field</th>
                              <th>Value</th>
                            </tr></thead>
                            <tbody>
                              ${Object.keys(payload).map(key => `
                                <tr>
                                    <td>${key}</td>
                                    <td>${payload[key]}</td>
                                </tr>
                                `)}
                            </tbody>
                          </table>
                      </div>
                      <div class="column c60-panel">
                        <h2>Raw</h2>
                        <pre>${JSON.stringify(payload, null, 4)}</pre>
                      </div>
                    </div>
                </div>`
            }

            function main() {
                $('#api-info').html(`API is at ${coreAPIURL} count ${counter}`)
                $.ajax({
                    url: coreAPIURL,
                    type: "GET",
                    data: { "Content-Type": undefined },
                    success: (result) => {
                        const { mongo, edge, file, ...core } = result
                        core.url = coreAPIURL
                        let dump = renderSection('Core', false, core)
                        dump += renderSection('Edge', false, edge)
                        dump += renderSection('Mongo', false, mongo)
                        dump += renderSection('File', false, file)
                        $('#data-dump').html(dump)
                        $('#api-response').html(`API result from (${coreAPIURL}):${JSON.stringify(result)}`)
                    },
                    error: (err) =>
                        $('#api-response').html(`API  error from (${coreAPIURL}): ${JSON.stringify(err)}`)
                })
                counter++
                $('#counter').html(counter)
            }

            $(document).ready(() => setInterval(main, 1000))
        </script>
    </body>

</html>