<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
        <style>
            .c60-panel {
                background-color: lightgrey;
            }
            .logo {
                width: 40px;
                height: 40px;
            }
            body {
                margin-top: 50px;
                margin-bottom: 50px;
            }
            pre {
                white-space: pre-wrap;       /* Since CSS 2.1 */
                white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
                white-space: -pre-wrap;      /* Opera 4-6 */
                white-space: -o-pre-wrap;    /* Opera 7 */
                word-wrap: break-word;       /* Internet Explorer 5.5+ */
            }
        </style>
    </head>
    <body>
        <div class="ui centered aligned container">
            <div class="ui grid">
                <div class="two column row">
                    <div class="left floated middle aligned column">
                    <h1 class='border-1'><img src='c6o.png' class='logo'> Sample Kubernetes Project</h1>
                    </div>
                    <div class="right floated right aligned column">
                    <div class="ui statistic">
                        <div id="counter" class="value"></div>
                        <div class="label">requests</div>
                    </div>
                    </div>
                </div>
            </div>

            <div id="data-dump"></div>

            <div class="ui divider"></div>
            <div class="footer">
                <div class="ui label">
                    <a href="https://github.com/c6o/sample-project" target="_blank"><i class="github icon"></i>https://github.com/c6o/sample-project</a>
                </div>
                Made with ‚ù§Ô∏è and üçª in üá®üá¶
            </div>
        </div>

        <script>
            const isLocal = window.location.hostname === 'localhost'
            // URL's depend if we are running in cluster or not
            // We can use the hostname to determine configuration
            // When localhost, we are doing local development
            const coreAPIURL = isLocal ?
                'http://localhost:3000/api' :
                '/api'

            const socketsURL = isLocal ?
                'ws://localhost:8999' :
                `ws://${window.location.host}/sockets`

            function renderSection(section, payload) {
                if (payload.error)
                    return renderError(section, 'Error', payload.error)
                return `<div class="ui divider"></div>
                <div class="ui two column grid">
                    <div class="row">
                        <div class="column">
                            <h2>${section}</h2>
                        </div>
                    </div>
                    <div class="row">
                      <div class="column">
                        <table class="ui celled table">
                            <thead>
                              <tr>
                                <th>Field</th>
                                <th>Value</th>
                              </tr>
                            </thead>
                            <tbody>
                              ${Object.keys(payload).map(key => `<tr>
                                    <td>${key}</td>
                                    <td>${payload[key]}</td>
                                </tr>`).join('')}
                            </tbody>
                          </table>
                      </div>
                      <div class="column c60-panel">
                        <h2>&nbsp;</h2>
                        <pre>${JSON.stringify(payload, null, 4)}</pre>
                      </div>
                    </div>
                </div>`
            }

            function renderError(section, title, error) {
                return `<div class="ui divider"></div>
                <div class="ui two column grid">
                    <div class="row">
                        <div class="column">
                            <h2>${section}</h2>
                        </div>
                    </div>
                    <div class="ui icon message">
                        <i class="exclamation triangle icon" style="color: red;"></i>
                        <div class="content">
                            <div class="header">
                            ${title}
                            </div>
                            <p>${error}</p>
                        </div>
                    </div>
                </div><p>&nbsp;</p>`
            }

            // State
            let counter = 0
            let wsOpened = false
            let wsSupported = 'WebSocket' in window
            function WebSocketTest() {
                if (wsSupported) {

                    //$('#ws-info').html("Communicating with WebSockets at: " + socket_uri)
                    //$('#ws-support').html("WebSocket is supported by this Browser!")

                    const ws = new WebSocket(socketsURL)
                    ws.onopen = () => {
                        // Web Socket is connected, send data using send()
                        // $('#ws-sent').html("Sent Message:\"Hello World\"")
                        wsOpened = true
                        ws.send(`Hello World ${counter}`)
                    }
                    ws.onclose = () => {
                        // $('#ws-closed').html(`Closed connection ${counter}...`)
                    }

                    ws.onmessage = function (evt) {
                        const received_msg = evt.data
                        console.log('ws onmessage', received_msg)
                        // if (received_msg.includes('PING'))
                        //     $('#ws-ping-messages').html("Ping received: "+received_msg)
                        // else
                        //     $('#ws-messages').html("Message received: "+received_msg)

                    }
                }
            }

            function main() {
                $.ajax({
                    url: coreAPIURL,
                    type: "GET",
                    data: { "Content-Type": undefined },
                    success: (result) => {
                        const { mongo, leaf, file, ...core } = result
                        core.url = coreAPIURL
                        let dump = renderSection('Core', core)
                        dump += renderSection('Leaf', leaf)
                        dump += renderSection('Database', mongo)
                        dump += renderSection('File', file)
                        $('#data-dump').html(dump)
                    },
                    error: (err) =>
                        $('#data-dump').html(renderError('Frontend', `Failed to reach ${coreAPIURL}`, `The sample-project-core service may have failed to start or is still spinning up.`))
                })

                WebSocketTest()

                counter++
                $('#counter').html(counter)
            }

            $(document).ready(() => setInterval(main, 1000))
            // Comment out the above and use below if you want a single call
            // $(document).ready(main)
        </script>
    </body>

</html>